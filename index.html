<!-- 
  Copyright © [2024] [Dustin_Chen]. All rights reserved.
  Author: Dustin Chen
  Email:  chuhpsdustin@gmail.com
-->

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QXDM_0xB821_0xB950_to_OAI_conf</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            line-height: 1;
            margin: 0;
            padding: 0;
        }
        body {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .header {
            text-align: center;
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            line-height: 1;
        }
        .header h1 {
            line-height: 1;
            margin-bottom: 5px;
        }
        .header p {
            line-height: 1;
            font-size: 14px;
        }
        .input-section, .output-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        h2 {
            line-height: 1;
            margin: 5px 0;
        }
        textarea {
            width: 100%;
            height: 300px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            line-height: 1.2;
            font-size: 12px;
        }
        .button-container {
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        button {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }
        button:hover {
            background-color: #2980b9;
        }
        .output-section {
            margin-top: 10px;
        }
        .info {
            background-color: #e7f3ff;
            padding: 8px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
            line-height: 1.2;
            font-size: 14px;
        }
        .info p {
            margin: 0;
        }
        .status {
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            margin-top: 5px;
            line-height: 1;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>QXDM_0xB821_0xB950_to_OAI_conf</h2>
            <p style="margin: 0; color: white;">【Author】: Dustin_Chen, 【Email】: <a href="mailto:dustincompal@gmail.com" style="color: inherit; line-height: 1;">dustincompal@gmail.com</a> or <a href="mailto:chuhpsdustin@gmail.com" style="color: inherit; line-height: 1;">chuhpsdustin@gmail.com</a></p>
        </div>
        
        <div class="info">
            <p><strong>How to use：</strong> QXDM Options->Export Parsed Text，把QXDM[0xB821][0xB950]packet複製貼到輸入框，Click "Convert"即可解析出OAI conf</p>
            <p><strong>注意：</strong> 根據3GPP 38.331規範，如果檢測到有dl-UL-TransmissionPeriodicity-v1530，則忽略dl-UL-TransmissionPeriodicity</p>
        </div>
        
        <div class="input-section">
            <h3>Input QXDM SIB1 log</h3>
            <textarea id="inputText" placeholder="請在此處貼上 QXDM SIB1 日誌..."></textarea>
            <div class="button-container">
                <button id="convertBtn">轉換</button>
                <button id="clearBtn">清除</button>
                <button id="exampleBtn">載入範例</button>
            </div>
        </div>
        
        <div class="output-section">
            <h3>Output OAI conf</h3>
            <textarea id="outputText" placeholder="轉換後的 OAI 配置將顯示在這裡..." readonly></textarea>
            <div class="button-container">
                <button id="copyBtn">複製到剪貼簿</button>
            </div>
        </div>
        
        <div id="statusMessage" class="status" style="display: none;"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const inputText = document.getElementById('inputText');
            const outputText = document.getElementById('outputText');
            const convertBtn = document.getElementById('convertBtn');
            const clearBtn = document.getElementById('clearBtn');
            const copyBtn = document.getElementById('copyBtn');
            const exampleBtn = document.getElementById('exampleBtn');
            const statusMessage = document.getElementById('statusMessage');
            
            // 範例資料 - QXDM格式
            const exampleData = `20:45:29.807326
20:45:29.807326	[0xB821]	BCCH_DL_SCH / SystemInformationBlockType1
Pkt Version = 9
RRC Release Number.Major.minor = 15.9.0
Radio Bearer ID = 0, Physical Cell ID = 186
NR Cell Global Id = N/A
Freq = 644736
Sfn = 608, SubFrameNum = 0
slot = 0
PDU Number = BCCH_DL_SCH Message,    Msg Length = 123
SIB Mask in SI =  0x02

Interpreted PDU:

value BCCH-DL-SCH-Message ::= 
{
  message c1 : systemInformationBlockType1 : 
      {
        cellSelectionInfo 
        {
          q-RxLevMin -70,
          q-QualMin -25
        },
        cellAccessRelatedInfo 
        {
          plmn-IdentityList 
          {
            {
              plmn-IdentityList 
              {
                {
                  mcc 
                  {
                    0,
                    0,
                    1
                  },
                  mnc 
                  {
                    0,
                    1
                  }
                }
              },
              trackingAreaCode '00000000 00000000 00000001'B,
              cellIdentity '00000000 00000000 10011110 00000000 0001'B,
              cellReservedForOperatorUse notReserved
            }
          }
        },
        si-SchedulingInfo 
        {
          schedulingInfoList 
          {
            {
              si-BroadcastStatus broadcasting,
              si-Periodicity rf32,
              sib-MappingInfo 
              {
                {
                  type sibType2,
                  valueTag 0
                },
                {
                  type sibType4,
                  valueTag 0
                },
                {
                  type sibType5,
                  valueTag 0
                }
              }
            }
          },
          si-WindowLength s5
        },
        servingCellConfigCommon 
        {
          downlinkConfigCommon 
            {
              frequencyInfoDL 
              {
                frequencyBandList 
                {
                  {
                    freqBandIndicatorNR 78
                  }
                },
                offsetToPointA 24,
                scs-SpecificCarrierList 
                {
                  {
                    offsetToCarrier 0,
                    subcarrierSpacing kHz30,
                    carrierBandwidth 273
                  }
                }
              },
              initialDownlinkBWP 
              {
                genericParameters 
                {
                  locationAndBandwidth 1099,
                  subcarrierSpacing kHz30
                },
                pdcch-ConfigCommon setup : 
                  {
                    controlResourceSetZero 10,
                    searchSpaceZero 0,
                    commonSearchSpaceList 
                    {
                      {
                        searchSpaceId 1,
                        controlResourceSetId 0,
                        monitoringSlotPeriodicityAndOffset sl1 : NULL,
                        monitoringSymbolsWithinSlot '10000000 000000'B,
                        nrofCandidates 
                        {
                          aggregationLevel1 n0,
                          aggregationLevel2 n0,
                          aggregationLevel4 n4,
                          aggregationLevel8 n2,
                          aggregationLevel16 n1
                        },
                        searchSpaceType common : 
                          {
                            dci-Format0-0-AndFormat1-0 
                            {
                            }
                          }
                      }
                    },
                    searchSpaceSIB1 0,
                    searchSpaceOtherSystemInformation 1,
                    pagingSearchSpace 1,
                    ra-SearchSpace 1
                  },
                pdsch-ConfigCommon setup : 
                  {
                    pdsch-TimeDomainAllocationList 
                    {
                      {
                        mappingType typeA,
                        startSymbolAndLength 40
                      },
                      {
                        mappingType typeA,
                        startSymbolAndLength 96
                      },
                      {
                        mappingType typeA,
                        startSymbolAndLength 68
                      }
                    }
                  }
              },
              bcch-Config 
              {
                modificationPeriodCoeff n2
              },
              pcch-Config 
              {
                defaultPagingCycle rf32,
                nAndPagingFrameOffset oneSixteenthT : 3,
                ns one,
                firstPDCCH-MonitoringOccasionOfPO sCS120KHZquarterT-SCS60KHZoneEighthT-SCS30KHZoneSixteenthT : 
                  {
                    2
                  }
              }
            },
          uplinkConfigCommon 
            {
              frequencyInfoUL 
              {
                scs-SpecificCarrierList 
                {
                  {
                    offsetToCarrier 0,
                    subcarrierSpacing kHz30,
                    carrierBandwidth 273
                  }
                },
                p-Max 23
              },
              initialUplinkBWP 
              {
                genericParameters 
                {
                  locationAndBandwidth 1099,
                  subcarrierSpacing kHz30
                },
                rach-ConfigCommon setup : 
                  {
                    rach-ConfigGeneric 
                    {
                      prach-ConfigurationIndex 147,
                      msg1-FDM one,
                      msg1-FrequencyStart 2,
                      zeroCorrelationZoneConfig 10,
                      preambleReceivedTargetPower -90,
                      preambleTransMax n6,
                      powerRampingStep dB4,
                      ra-ResponseWindow sl20
                    },
                    ssb-perRACH-OccasionAndCB-PreamblesPerSSB one : n32,
                    groupBconfigured 
                    {
                      ra-Msg3SizeGroupA b144,
                      messagePowerOffsetGroupB dB0,
                      numberOfRA-PreamblesGroupA 4
                    },
                    ra-ContentionResolutionTimer sf64,
                    rsrp-ThresholdSSB 0,
                    prach-RootSequenceIndex l139 : 4,
                    msg1-SubcarrierSpacing kHz30,
                    restrictedSetConfig unrestrictedSet
                  },
                pusch-ConfigCommon setup : 
                  {
                    pusch-TimeDomainAllocationList 
                    {
                      {
                        k2 1,
                        mappingType typeA,
                        startSymbolAndLength 27
                      },
                      {
                        k2 2,
                        mappingType typeA,
                        startSymbolAndLength 27
                      },
                      {
                        k2 3,
                        mappingType typeA,
                        startSymbolAndLength 27
                      },
                      {
                        k2 4,
                        mappingType typeA,
                        startSymbolAndLength 27
                      },
                      {
                        k2 5,
                        mappingType typeA,
                        startSymbolAndLength 27
                      }
                    },
                    msg3-DeltaPreamble 0,
                    p0-NominalWithGrant -96
                  },
                pucch-ConfigCommon setup : 
                  {
                    pucch-ResourceCommon 12,
                    pucch-GroupHopping neither,
                    p0-nominal -96
                  }
              },
              timeAlignmentTimerCommon infinity
            },
          ssb-PositionsInBurst 
          {
            inOneGroup '10000000'B
          },
          ssb-PeriodicityServingCell ms20,
          tdd-UL-DL-ConfigurationCommon 
          {
            referenceSubcarrierSpacing kHz30,
            pattern1 
            {
              dl-UL-TransmissionPeriodicity ms2p5,
              nrofDownlinkSlots 3,
              nrofDownlinkSymbols 10,
              nrofUplinkSlots 1,
              nrofUplinkSymbols 2,
              dl-UL-TransmissionPeriodicity-v1530 ms3
            },
            pattern2 
            {
              dl-UL-TransmissionPeriodicity ms2p5,
              nrofDownlinkSlots 2,
              nrofDownlinkSymbols 10,
              nrofUplinkSlots 2,
              nrofUplinkSymbols 2
            }
          },
          ss-PBCH-BlockPower -11
        },
        ims-EmergencySupport true,
        ue-TimersAndConstants 
        {
          t300 ms1000,
          t301 ms200,
          t310 ms1000,
          n310 n10,
          t311 ms10000,
          n311 n1,
          t319 ms1000
        }
      }
}`;

            // 載入範例資料
            exampleBtn.addEventListener('click', function() {
                inputText.value = exampleData;
                showStatus('已載入範例資料', 'success');
            });

            // 清除輸入和輸出
            clearBtn.addEventListener('click', function() {
                inputText.value = '';
                outputText.value = '';
                hideStatus();
            });

            // 複製到剪貼簿
            copyBtn.addEventListener('click', function() {
                if (outputText.value) {
                    outputText.select();
                    document.execCommand('copy');
                    showStatus('已複製到剪貼簿', 'success');
                } else {
                    showStatus('沒有內容可複製', 'error');
                }
            });

            // 轉換功能
            convertBtn.addEventListener('click', function() {
                const input = inputText.value.trim();
                if (!input) {
                    showStatus('請輸入QXDM SIB1日誌', 'error');
                    return;
                }

                try {
                    const config = convertQXDMToOAI(input);
                    outputText.value = config;
                    showStatus('轉換成功！', 'success');
                } catch (error) {
                    showStatus('轉換失敗: ' + error.message, 'error');
                    console.error(error);
                }
            });

            // 轉換函數 - 針對QXDM格式
            function convertQXDMToOAI(input) {
                // 提取數值函數
                const extractValue = (pattern, defaultValue = null) => {
                    const match = input.match(pattern);
                    return match ? match[1] : defaultValue;
                };

                // 提取數字值
                const extractNumber = (pattern, defaultValue = 0) => {
                    const match = input.match(pattern);
                    return match ? parseInt(match[1], 10) : defaultValue;
                };

                // 提取十六進制值
                const extractHex = (pattern, defaultValue = 0) => {
                    const match = input.match(pattern);
                    return match ? '0x' + parseInt(match[1], 10).toString(16) : defaultValue;
                };

                // 二進制字符串轉整數
                const binaryToInt = (binaryStr) => {
                    // 移除空格和'B
                    const cleanStr = binaryStr.replace(/'/g, '').replace(/ /g, '').replace(/B$/, '');
                    return parseInt(cleanStr, 2);
                };

                // 提取參數 - QXDM格式
                const physCellId = extractNumber(/Physical Cell ID = (\d+)/, 186);
                
                // 提取 tracking_area_code - 從二進制字符串
                const tracking_area_code = (() => {
                    const match = input.match(/trackingAreaCode '([01 ]+)'B/);
                    return match ? binaryToInt(match[1]) : 1;
                })();
                
                // 提取 nr_cellid - 從二進制字符串
                const nr_cellid = (() => {
                    const match = input.match(/cellIdentity '([01 ]+)'B/);
                    return match ? binaryToInt(match[1]) : 12345678;
                })();
                
                // 提取頻率相關參數 - 修正的邏輯
                const absoluteFrequencySSB = (() => {
                    // 先嘗試從新的 DL Frequency Info 格式提取 (Abs Freq SSB)
                    const newFreqMatch = input.match(/Abs Freq SSB\s*=\s*(\d+)/i);
                    if (newFreqMatch) return parseInt(newFreqMatch[1], 10);
                    
                    // 再嘗試從舊的 DL Frequency Info 格式提取 (abs_freq_ssb)
                    const oldFreqMatch = input.match(/abs_freq_ssb\s*=\s*(\d+)/i);
                    if (oldFreqMatch) return parseInt(oldFreqMatch[1], 10);
                    
                    // 最後嘗試從傳統格式提取
                    const tradMatch = input.match(/Freq\s*=\s*(\d+)/);
                    return tradMatch ? parseInt(tradMatch[1], 10) : 644736;
                })();
                
                const dl_absoluteFrequencyPointA = (() => {
                    // 先嘗試從新的 DL Frequency Info 格式提取 (Abs Freq Point A)
                    const newFreqMatch = input.match(/Abs Freq Point A\s*=\s*(\d+)/i);
                    if (newFreqMatch) return parseInt(newFreqMatch[1], 10);
                    
                    // 再嘗試從舊的 DL Frequency Info 格式提取 (abs_freq_point_a)
                    const oldFreqMatch = input.match(/abs_freq_point_a\s*=\s*(\d+)/i);
                    if (oldFreqMatch) return parseInt(oldFreqMatch[1], 10);
                    
                    // 如果都沒有找到，使用 SSB 頻率減去固定偏移作為備用
                    return absoluteFrequencySSB - 528;
                })();
                
                // 提取頻段
                const dl_frequencyBand = (() => {
                    // 先嘗試從頻段指示器提取
                    const bandMatch = input.match(/freqBandIndicatorNR\s+(\d+)/i);
                    if (bandMatch) return parseInt(bandMatch[1], 10);
                    
                    // 再嘗試從 BAND 字段提取
                    const bandStrMatch = input.match(/band\s*=\s*BAND(\d+)/i);
                    if (bandStrMatch) return parseInt(bandStrMatch[1], 10);
                    
                    return 78; // 默認值
                })();
                
                const ul_frequencyBand = dl_frequencyBand; // 通常上下行頻段相同
                
                // 提取帶寬相關參數
                const dl_offstToCarrier = extractNumber(/offsetToCarrier (\d+)/, 0);
                const dl_subcarrierSpacing = 1; // kHz30
                const dl_carrierBandwidth = extractNumber(/carrierBandwidth (\d+)/, 273);
                
                // BWP參數
                const initialDLBWPlocationAndBandwidth = extractNumber(/locationAndBandwidth (\d+)/, 1099);
                const initialDLBWPsubcarrierSpacing = 1; // kHz30
                const initialDLBWPcontrolResourceSetZero = extractNumber(/controlResourceSetZero (\d+)/, 10);
                const initialDLBWPsearchSpaceZero = extractNumber(/searchSpaceZero (\d+)/, 0);
                
                // 上行參數
                const ul_offstToCarrier = extractNumber(/offsetToCarrier (\d+)/, 0);
                const ul_subcarrierSpacing = 1; // kHz30
                const ul_carrierBandwidth = extractNumber(/carrierBandwidth (\d+)/, 273);
                const pMax = extractNumber(/p-Max (\d+)/, 23);
                const initialULBWPlocationAndBandwidth = extractNumber(/locationAndBandwidth (\d+)/, 1099);
                const initialULBWPsubcarrierSpacing = 1; // kHz30
                const prach_ConfigurationIndex = extractNumber(/prach-ConfigurationIndex (\d+)/, 147);
                const prach_msg1_FDM = 0; // one
                const prach_msg1_FrequencyStart = extractNumber(/msg1-FrequencyStart (\d+)/, 2);
                const zeroCorrelationZoneConfig = extractNumber(/zeroCorrelationZoneConfig (\d+)/, 10);
                const preambleReceivedTargetPower = extractNumber(/preambleReceivedTargetPower (-\d+)/, -90);
                
                // 修正preambleTransMax轉換
                const preambleTransMax = (() => {
                    const match = input.match(/preambleTransMax\s+n(\d+)/);
                    if (match) {
                        const value = parseInt(match[1], 10);
                        // OAI中preambleTransMax的映射: n3=0, n4=1, n5=2, n6=3, n7=4, n8=5, n10=6, n20=7, n50=8, n100=9, n200=10
                        const mapping = {3:0, 4:1, 5:2, 6:3, 7:4, 8:5, 10:6, 20:7, 50:8, 100:9, 200:10};
                        return mapping[value] !== undefined ? mapping[value] : 3; // 默認n6=3
                    }
                    return 3; // 默認n6=3
                })();
                
                // 提取 powerRampingStep
                const powerRampingStep = (() => {
                    const match = input.match(/powerRampingStep dB(\d+)/);
                    return match ? parseInt(match[1])/2 : 2; // dB4 -> 2
                })();
                
                // 修正ssb_perRACH_OccasionAndCB_PreamblesPerSSB轉換
                const ssb_perRACH_OccasionAndCB_PreamblesPerSSB = (() => {
                    const match = input.match(/one\s*:\s*n(\d+)/);
                    if (match) {
                        const value = parseInt(match[1], 10);
                        // 映射: 4=0, 8=1, 12=2, 16=3, 20=4, 24=5, 28=6, 32=7, 36=8, 40=9, 44=10, 48=11, 52=12, 56=13, 60=14, 64=15
                        return (value / 4) - 1;
                    }
                    return 7; // 默認n32=7
                })();
                
                const ssb_perRACH_OccasionAndCB_PreamblesPerSSB_PR = 4; // one
                
                const ra_ContentionResolutionTimer = 7; // sf64 (7)
                const rsrp_ThresholdSSB = extractNumber(/rsrp-ThresholdSSB (\d+)/, 0);
                
                // 修正prach_RootSequenceIndex轉換
                const prach_RootSequenceIndex_PR = (() => {
                    const match = input.match(/prach-RootSequenceIndex\s+(l139|l839)\s*:\s*(\d+)/);
                    return match && match[1] === 'l139' ? 2 : 1; // l139 = 2, l839 = 1
                })();
                
                const prach_RootSequenceIndex = 1; // 根據要求固定為1
                
                const msg1_SubcarrierSpacing = 1; // kHz30
                const restrictedSetConfig = 0; // unrestrictedSet
                const msg3_DeltaPreamble = extractNumber(/msg3-DeltaPreamble (\d+)/, 0);
                const p0_NominalWithGrant = extractNumber(/p0-NominalWithGrant (-\d+)/, -96);
                const pucchGroupHopping = 0; // neither
                const hoppingId = 40; // 默認值
                const p0_nominal = extractNumber(/p0-nominal (-\d+)/, -96);
                
                // SSB參數
                const ssb_PositionsInBurst_Bitmap = (() => {
                    const match = input.match(/inOneGroup '([01 ]+)'B/);
                    return match ? binaryToInt(match[1]) : 128;
                })();
                
                const ssb_periodicityServingCell = 2; // ms20
                const dmrs_TypeA_Position = 0; // pos2
                const subcarrierSpacing = 1; // kHz30
                const referenceSubcarrierSpacing = 1; // kHz30
                
                // 提取TDD配置 - 支持雙周期並遵循3GPP規範
                const extractTDDConfig = () => {
                    const tddConfig = {
                        pattern1: {},
                        pattern2: null
                    };

                    // 從SIB1提取pattern1
                    const pattern1Match = input.match(/pattern1[^{]*{\s*dl-UL-TransmissionPeriodicity\s+ms(\d+(?:p\d+)?),\s*nrofDownlinkSlots\s+(\d+),\s*nrofDownlinkSymbols\s+(\d+),\s*nrofUplinkSlots\s+(\d+),\s*nrofUplinkSymbols\s+(\d+)(?:\s*,\s*dl-UL-TransmissionPeriodicity-v1530\s+ms(\d+(?:p\d+)?))?/);
                    
                    if (pattern1Match) {
                        // 檢查是否存在v1530版本，如果存在則使用v1530，否則使用原始版本
                        const periodicity = pattern1Match[6] ? pattern1Match[6] : pattern1Match[1];
                        
                        tddConfig.pattern1 = {
                            dl_UL_TransmissionPeriodicity: mapPeriodicity(periodicity),
                            nrofDownlinkSlots: parseInt(pattern1Match[2], 10),
                            nrofDownlinkSymbols: parseInt(pattern1Match[3], 10),
                            nrofUplinkSlots: parseInt(pattern1Match[4], 10),
                            nrofUplinkSymbols: parseInt(pattern1Match[5], 10)
                        };
                    }

                    // 從SIB1提取pattern2
                    const pattern2Match = input.match(/pattern2[^{]*{\s*dl-UL-TransmissionPeriodicity\s+ms(\d+(?:p\d+)?),\s*nrofDownlinkSlots\s+(\d+),\s*nrofDownlinkSymbols\s+(\d+),\s*nrofUplinkSlots\s+(\d+),\s*nrofUplinkSymbols\s+(\d+)(?:\s*,\s*dl-UL-TransmissionPeriodicity-v1530\s+ms(\d+(?:p\d+)?))?/);
                    
                    if (pattern2Match) {
                        // 檢查是否存在v1530版本，如果存在則使用v1530，否則使用原始版本
                        const periodicity = pattern2Match[6] ? pattern2Match[6] : pattern2Match[1];
                        
                        tddConfig.pattern2 = {
                            dl_UL_TransmissionPeriodicity: mapPeriodicity(periodicity),
                            nrofDownlinkSlots: parseInt(pattern2Match[2], 10),
                            nrofDownlinkSymbols: parseInt(pattern2Match[3], 10),
                            nrofUplinkSlots: parseInt(pattern2Match[4], 10),
                            nrofUplinkSymbols: parseInt(pattern2Match[5], 10)
                        };
                    }

                    return tddConfig;
                };

                // 周期字符串映射到OAI數值 - 更新以支持所有周期值
                function mapPeriodicity(periodStr) {
                    switch(periodStr) {
                        case '0p5': return 0;    // ms0.5
                        case '0p625': return 1;  // ms0.625  
                        case '1': return 2;      // ms1
                        case '1p25': return 3;   // ms1.25
                        case '2': return 4;      // ms2
                        case '2p5': return 5;    // ms2.5
                        case '5': return 6;      // ms5
                        case '10': return 7;     // ms10
                        case '3': return 8;      // ms3 (v1530)
                        case '4': return 9;      // ms4 (v1530)
                        default: return 5;       // 默認ms2.5
                    }
                }

                const tddConfig = extractTDDConfig();
                const ssPBCH_BlockPower = extractNumber(/ss-PBCH-BlockPower (-\d+)/, -11);

                // gNB配置
                const gNB_DU_ID = 3584; // 默認值
                const gNB_DU_Name = "du-rfsim"; // 默認值
                const gNB_ID_hex = '0x' + (gNB_DU_ID).toString(16);
                const gNB_DU_ID_hex = '0x' + (gNB_DU_ID).toString(16);

                // 構建TDD配置部分 - 支持雙周期
                const buildTDDConfig = () => {
                    let tddOutput = `  #tdd-UL-DL-ConfigurationCommon
# subcarrierSpacing
# 0=kHz15, 1=kHz30, 2=kHz60, 3=kHz120
      referenceSubcarrierSpacing                                   = ${referenceSubcarrierSpacing};

      # pattern1
      # dl_UL_TransmissionPeriodicity
      # 0=ms0p5, 1=ms0p625, 2=ms1, 3=ms1p25, 4=ms2, 5=ms2p5, 6=ms5, 7=ms10
      # ext: 8=ms3, 9=ms4
      dl_UL_TransmissionPeriodicity                                = ${tddConfig.pattern1.dl_UL_TransmissionPeriodicity || 5};
      nrofDownlinkSlots                                            = ${tddConfig.pattern1.nrofDownlinkSlots || 3};
      nrofDownlinkSymbols                                          = ${tddConfig.pattern1.nrofDownlinkSymbols || 10};
      nrofUplinkSlots                                              = ${tddConfig.pattern1.nrofUplinkSlots || 1};
      nrofUplinkSymbols                                            = ${tddConfig.pattern1.nrofUplinkSymbols || 2};`;

                    // 如果有pattern2，添加pattern2配置
                    if (tddConfig.pattern2) {
                        tddOutput += `

      # pattern2
      pattern2: {
        dl_UL_TransmissionPeriodicity2                             = ${tddConfig.pattern2.dl_UL_TransmissionPeriodicity};
        nrofDownlinkSlots2                                         = ${tddConfig.pattern2.nrofDownlinkSlots};
        nrofDownlinkSymbols2                                       = ${tddConfig.pattern2.nrofDownlinkSymbols};
        nrofUplinkSlots2                                           = ${tddConfig.pattern2.nrofUplinkSlots};
        nrofUplinkSymbols2                                         = ${tddConfig.pattern2.nrofUplinkSymbols};
      };`;
                    }

                    return tddOutput;
                };

                // 構建OAI配置
                return `Active_gNBs = ( "${gNB_DU_Name}");
# Asn1_verbosity, choice in: none, info, annoying
Asn1_verbosity = "none";

gNBs =
(
 {
    ////////// Identification parameters:
    gNB_ID = ${gNB_ID_hex};
    gNB_DU_ID = ${gNB_DU_ID_hex};
    gNB_name  =  "${gNB_DU_Name}";

    // Tracking area code, 0x0000 and 0xfffe are reserved values
    tracking_area_code  =  ${tracking_area_code};
    plmn_list = ({ mcc = 001; mnc = 01; mnc_length = 2; snssaiList = ({ sst = 1; }) });

    nr_cellid = ${nr_cellid}L;

    ////////// Physical parameters:

    min_rxtxtime = 6;

    servingCellConfigCommon = (
    {
 #spCellConfigCommon

      physCellId                                               = ${physCellId};

#  downlinkConfigCommon
    #frequencyInfoDL
      # this is the SSB frequency
      absoluteFrequencySSB                                      = ${absoluteFrequencySSB};
      dl_frequencyBand                                          = ${dl_frequencyBand};
      # this is the Point A frequency
      dl_absoluteFrequencyPointA                                = ${dl_absoluteFrequencyPointA};
      #scs-SpecificCarrierList
        dl_offstToCarrier                                       = ${dl_offstToCarrier};
# subcarrierSpacing
# 0=kHz15, 1=kHz30, 2=kHz60, 3=kHz120
        dl_subcarrierSpacing                                    = ${dl_subcarrierSpacing};
        dl_carrierBandwidth                                     = ${dl_carrierBandwidth};
     #initialDownlinkBWP
      #genericParameters
        # this is RBstart=27,L=48 (275*(L-1))+RBstart
        initialDLBWPlocationAndBandwidth                         = ${initialDLBWPlocationAndBandwidth}; # 6366 12925 12956 28875 12952
# subcarrierSpacing
# 0=kHz15, 1=kHz30, 2=kHz60, 3=kHz120
        initialDLBWPsubcarrierSpacing                             = ${initialDLBWPsubcarrierSpacing};
      #pdcch-ConfigCommon
        initialDLBWPcontrolResourceSetZero                        = ${initialDLBWPcontrolResourceSetZero};
        initialDLBWPsearchSpaceZero                               = ${initialDLBWPsearchSpaceZero};

  #uplinkConfigCommon
     #frequencyInfoUL
      ul_frequencyBand                                             = ${ul_frequencyBand};
      #scs-SpecificCarrierList
      ul_offstToCarrier                                            = ${ul_offstToCarrier};
# subcarrierSpacing
# 0=kHz15, 1=kHz30, 2=kHz60, 3=kHz120
      ul_subcarrierSpacing                                         = ${ul_subcarrierSpacing};
      ul_carrierBandwidth                                          = ${ul_carrierBandwidth};
      pMax                                                         = ${pMax};
     #initialUplinkBWP
      #genericParameters
        initialULBWPlocationAndBandwidth                           = ${initialULBWPlocationAndBandwidth};
# subcarrierSpacing
# 0=kHz15, 1=kHz30, 2=kHz60, 3=kHz120
        initialULBWPsubcarrierSpacing                              = ${initialULBWPsubcarrierSpacing};
      #rach-ConfigCommon
        #rach-ConfigGeneric
          prach_ConfigurationIndex                                 = ${prach_ConfigurationIndex};
#prach_msg1_FDM
#0 = one, 1=two, 2=four, 3=eight
          prach_msg1_FDM                                           = ${prach_msg1_FDM};
          prach_msg1_FrequencyStart                                = ${prach_msg1_FrequencyStart};
          zeroCorrelationZoneConfig                                = ${zeroCorrelationZoneConfig};
          preambleReceivedTargetPower                              = ${preambleReceivedTargetPower};
#preamblTransMax (0...10) = (3,4,5,6,7,8,10,20,50,100,200)
          preambleTransMax                                         = ${preambleTransMax};
#powerRampingStep
# 0=dB0,1=dB2,2=dB4,3=dB6
        powerRampingStep                                           = ${powerRampingStep};
#ssb_perRACH_OccasionAndCB_PreamblesPerSSB_PR
#1=oneeighth,2=onefourth,3=half,4=one,5=two,6=four,7=eight,8=sixteen
        ssb_perRACH_OccasionAndCB_PreamblesPerSSB_PR               = ${ssb_perRACH_OccasionAndCB_PreamblesPerSSB_PR};
#one (0..15) 4,8,12,16,...60,64
        ssb_perRACH_OccasionAndCB_PreamblesPerSSB                  = ${ssb_perRACH_OccasionAndCB_PreamblesPerSSB};
#ra_ContentionResolutionTimer
#(0..7) 8,16,24,32,40,48,56,64
        ra_ContentionResolutionTimer                               = ${ra_ContentionResolutionTimer};
        rsrp_ThresholdSSB                                          = ${rsrp_ThresholdSSB};
#prach-RootSequenceIndex_PR
#1 = 839, 2 = 139
        prach_RootSequenceIndex_PR                                 = ${prach_RootSequenceIndex_PR};
        prach_RootSequenceIndex                                    = ${prach_RootSequenceIndex};
        # SCS for msg1, can only be 15 for 30 kHz < 6 GHz, takes precendence over the one derived from prach-ConfigIndex
        #
        msg1_SubcarrierSpacing                                     = ${msg1_SubcarrierSpacing},
# restrictedSetConfig
# 0=unrestricted, 1=restricted type A, 2=restricted type B
        restrictedSetConfig                                        = ${restrictedSetConfig},

        msg3_DeltaPreamble                                         = ${msg3_DeltaPreamble};
        p0_NominalWithGrant                                        =${p0_NominalWithGrant};

# pucch-ConfigCommon setup :
# pucchGroupHopping
# 0 = neither, 1= group hopping, 2=sequence hopping
        pucchGroupHopping                                          = ${pucchGroupHopping};
        hoppingId                                                  = ${hoppingId};
        p0_nominal                                                 = ${p0_nominal};

      ssb_PositionsInBurst_Bitmap                                  = ${ssb_PositionsInBurst_Bitmap};

# ssb_periodicityServingCell
# 0 = ms5, 1=ms10, 2=ms20, 3=ms40, 4=ms80, 5=ms160, 6=spare2, 7=spare1
      ssb_periodicityServingCell                                   = ${ssb_periodicityServingCell};

# dmrs_TypeA_position
# 0 = pos2, 1 = pos3
      dmrs_TypeA_Position                                           = ${dmrs_TypeA_Position};

# subcarrierSpacing
# 0=kHz15, 1=kHz30, 2=kHz60, 3=kHz120
      subcarrierSpacing                                            = ${subcarrierSpacing};

${buildTDDConfig()}

      ssPBCH_BlockPower                                            = ${ssPBCH_BlockPower};
     }

  );

    # ------- SCTP definitions
    SCTP :
    {
        # Number of streams to use in input/output
        SCTP_INSTREAMS  = 2;
        SCTP_OUTSTREAMS = 2;
    };
  }
);

MACRLCs = ({
    num_cc              = 1;
    tr_s_preference     = "local_L1";
    tr_n_preference     = "f1";
    local_n_address     = "127.0.0.4";
    remote_n_address    = "127.0.0.3";
    local_n_portd       = 2152;
    remote_n_portd      = 2152;
    pusch_FailureThres  = 1000;
});

L1s = ({
    num_cc = 1;
    tr_n_preference = "local_mac";
    prach_dtx_threshold = 200;
    pucch0_dtx_threshold = 150;
    ofdm_offset_divisor = 8; #set this to UINT_MAX for offset 0
});

RUs = ({
    local_rf       = "yes"
    nb_tx          = 1
    nb_rx          = 1
    att_tx         = 0
    att_rx         = 0;
    bands          = [${dl_frequencyBand}];
    max_pdschReferenceSignalPower = -27;
    max_rxgain                    = 114;
    eNB_instances  = [0];
    clock_src = "internal";
});

rfsimulator: {
  serveraddr = "server";
  serverport = 4043;
  options = (); #("saviq"); or/and "chanmod"
  modelname = "AWGN";
  IQfile = "/tmp/rfsimulator.iqs"
}

log_config: {
  global_log_level = "info";
  hw_log_level     = "info";
  nr_phy_log_level = "info";
  nr_mac_log_level = "info";
  rlc_log_level    = "info";
  pdcp_log_level   = "info";
  rrc_log_level    = "info";
  f1ap_log_level   = "info";
  ngap_log_level   = "debug";
};

e2_agent = {
  near_ric_ip_addr = "127.0.0.1";
  sm_dir = "/usr/local/lib/flexric/"
};`;
            }

            // 顯示狀態消息
            function showStatus(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = 'status ' + type;
                statusMessage.style.display = 'block';
                
                // 3秒後自動隱藏
                setTimeout(hideStatus, 3000);
            }

            // 隱藏狀態消息
            function hideStatus() {
                statusMessage.style.display = 'none';
            }
        });
    </script>
</body>
</html>